# 🚀 Инструкция по использованию нового JRXML шаблона

## ✅ Что уже готово

1. **report_new.jrxml** - валидный JRXML шаблон с твоими требованиями
2. **JasperServiceNew.java** - сервис, который работает с твоими DTO
3. **CoordinatesDto.java** - обновлён, добавлены поля x и y
4. **ReportDto.java** - добавлены геттеры и сеттеры

## 📝 Как пользоваться (3 простых шага)

### Шаг 1: Подготовь данные

```java
// Создай ClientData с нужными значениями
ClientData clientData = new ClientData();
clientData.setColumn("Столбец 1");      // Первая ячейка таблицы
clientData.setValue("Значение 1");       // Вторая ячейка таблицы
clientData.setCrs("1 000 000 руб.");    // Цена
clientData.setArea("500 м²");            // Площадь

// Добавь координаты
List<CoordinatesDto> coordinates = new ArrayList<>();
coordinates.add(new CoordinatesDto("55.7558", "37.6173"));
coordinates.add(new CoordinatesDto("55.7559", "37.6174"));
coordinates.add(new CoordinatesDto("55.7560", "37.6175"));
clientData.setCoordinates(coordinates);

// Создай ReportDto
ReportDto reportDto = new ReportDto("PDF", clientData);
```

### Шаг 2: Вызови сервис

```java
@Autowired
private JasperServiceNew jasperService;

// Генерируй PDF
byte[] pdfBytes = jasperService.createPdf(reportDto);
```

### Шаг 3: Готово! 

PDF создан, можешь его сохранить или отправить клиенту.

## 🧪 Быстрое тестирование

У сервиса есть готовые методы для теста:

```java
// Тест с одной точкой
byte[] pdf1 = jasperService.createPointReport();

// Тест с полигоном (10 точек)
byte[] pdf2 = jasperService.createPolygonReport();
```

## 📊 Структура отчёта

### Страница 1
```
┌────────────────────────────────┐
│ Это тестовый шаблон отчёта    │
│                                │
│      [Картинка flower1.png]    │
│                                │
│  ┌──────────┬──────────┐      │
│  │ Ячейка 1 │ Ячейка 2 │      │
│  ├──────────┼──────────┤      │
│  │  CELL1   │  CELL2   │      │
│  └──────────┴──────────┘      │
└────────────────────────────────┘
```

**CELL1** = `clientData.getColumn()`  
**CELL2** = `clientData.getValue()`

### Страница 2
```
┌────────────────────────────────┐
│     Ведомость координат       │
│                                │
│  Цена: _________              │
│  Площадь: _________           │
│                                │
│  ┌───┬──────────┬──────────┐ │
│  │ № │    X     │    Y     │ │
│  ├───┼──────────┼──────────┤ │
│  │ 1 │ 55.7558  │ 37.6173  │ │
│  │ 2 │ 55.7559  │ 37.6174  │ │
│  │ 3 │ 55.7560  │ 37.6175  │ │
│  └───┴──────────┴──────────┘ │
└────────────────────────────────┘
```

**Цена** = `clientData.getCrs()`  
**Площадь** = `clientData.getArea()`  
**Таблица** = `clientData.getCoordinates()`

## 🔧 Твой текущий контроллер уже готов!

Твой `JasperController` уже настроен правильно:

```java
@GetMapping("/test")
public void createFile(@RequestParam ReportDto dto) {
    byte[] pdfBytes = jasperService.createPdf(dto);
    fileService.saveFile(pdfBytes);
}
```

Просто отправь GET запрос с правильными параметрами!

## 📮 Пример JSON для тестирования

Если будешь делать POST запрос:

```json
{
  "outputFormat": "PDF",
  "d": {
    "picture": "flower1.png",
    "title": "Тестовый отчёт",
    "column": "Первая ячейка",
    "value": "Вторая ячейка",
    "crs": "2 000 000 руб.",
    "area": "1000 м²",
    "coordinates": [
      {"x": "55.7558", "y": "37.6173"},
      {"x": "55.7559", "y": "37.6174"},
      {"x": "55.7560", "y": "37.6175"}
    ]
  }
}
```

## 🎨 Как изменить картинку

### Вариант 1: Замени файл
Положи свою картинку вместо `flower1.png` в `src/main/resources/`

### Вариант 2: Используй другой файл
1. Положи новую картинку в `src/main/resources/` (например, `logo.png`)
2. В `JasperServiceNew.java` измени строку:
```java
params.put("IMAGE_PATH", getClass().getResourceAsStream("/logo.png"));
```

### Вариант 3: Динамическая картинка
Если нужно менять картинку динамически, добавь параметр в метод:
```java
public byte[] createPdf(ReportDto reportDto, String imagePath) {
    // ...
    params.put("IMAGE_PATH", getClass().getResourceAsStream(imagePath));
}
```

## 🔍 Соответствие полей

| ClientData поле | JRXML параметр | Где отображается |
|-----------------|----------------|------------------|
| `column` | CELL1 | Первая ячейка таблицы (страница 1) |
| `value` | CELL2 | Вторая ячейка таблицы (страница 1) |
| `crs` | PRICE | Цена (страница 2) |
| `area` | AREA | Площадь (страница 2) |
| `coordinates` | datasource | Таблица координат (страница 2) |

## ❗ Важные замечания

1. **Координаты** - список может быть любого размера (от 1 до бесконечности), таблица автоматически растянется
2. **Разрыв страницы** - отчёт ВСЕГДА будет минимум 2 страницы (как ты просил)
3. **Номера** в таблице координат ставятся автоматически (1, 2, 3...)
4. **Null значения** - если параметр null, поле будет пустым (не будет ошибки)

## 🐛 Если что-то не работает

### Ошибка "Template not found"
→ Проверь что `report_new.jrxml` лежит в `src/main/resources/`

### Ошибка "Cannot find IMAGE_PATH"
→ Проверь что `flower1.png` есть в `src/main/resources/`

### Пустая таблица координат
→ Проверь что список `coordinates` не null и не пустой

### NullPointerException в createPdf
→ Проверь что `reportDto.d` не null

## 📂 Структура файлов проекта

```
src/main/
├── java/ru/mycrg/jasperreporte/
│   ├── JasperServiceNew.java     ← Используй этот сервис
│   ├── JasperController.java     ← Уже настроен правильно
│   └── dto/
│       ├── ReportDto.java        ← Обновлён
│       ├── ClientData.java       ← Используй как есть
│       └── CoordinatesDto.java   ← Обновлён
└── resources/
    ├── report_new.jrxml          ← Новый шаблон ✅
    ├── report.jrxml              ← Старый (не трогай)
    └── flower1.png               ← Картинка
```

## 🎯 Следующие шаги

1. **Запусти приложение** (я не могу это сделать, у меня нет доступа к Java/Docker)
2. **Протестируй** эндпоинт `/test` с твоими данными
3. **Проверь** сгенерированный PDF
4. **Настрой** под свои нужды (если нужно что-то изменить)

## 📞 Что дальше?

После тестирования скажи мне:
- ✅ Всё работает
- ❌ Есть ошибки (покажи текст ошибки)
- 🔧 Нужно что-то изменить (скажи что именно)

---

**Готово к запуску! 🎉**
